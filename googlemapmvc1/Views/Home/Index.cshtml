
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width",initial-scale="1" />
    <title>Index</title>
    <style>#map {height : 500px ;width : 970px; position : absolute; left : 350px;top: 65px; border-radius : 10px}
    select {position : absolute;
                left:50px;
                top:65px;
                font-size: 16px;
                display: inline-block;
                border-radius : 10px

    }
  



    p {font-size : 20px}
    body {
    background-color: white}
    #infotext{position : absolute; top : 365px;left : 50px ;
              border : 1px;border-style : solid; border-color : black;
              height : 200px; width : 250px;border-radius : 10px
    }
    #route {position : absolute; top : 140px;left : 50px ;
              border : 1px;border-style : solid; border-color : black;
              height : 200px; width : 250px;border-radius : 10px


    }
    #buttonroute { position : relative; top : 10px; left : 5px}
   #buttonroute-hide{position : absolute; top : 40px;left : 5px }
    
    </style>
</head>
<body>
   

                <div id="map">
                   </div>

               
                <select  name="scancars" id="scancars">
                    <option value="">Select scanpatrol</option>
                    <option value="">All scanpatrollers</option>
                </select>

    <div id="route">
    <button id="buttonroute" type="button">show route</button>
    <button id="buttonroute-hide" type="button">hide route</button>
    </div>


    <div id="infotext">   </div>

                
                   
        
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>
    <script src="~/Scripts/moment.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDe1iRGmDMXSwy0py_TRHruCp49TO0eyuU"></script>
    <script type="text/javascript">


        var markers = @Html.Raw(ViewBag.Jsonlist);
        var patrollers =@Html.Raw(ViewBag.Patrollistjson);
        var colors = ["red","blue","yellow","green","orange"];
        var infowindow = new google.maps.InfoWindow();
        var gmarkers = [];
        var scancars = document.getElementById("scancars");
        var scancarselected = scancars.value;
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var directionmarkers = [];

        for (i=1;i<=patrollers.length;i++) {
            $('#scancars').append ("<option value="+patrollers[i]+">patroller" + i  + "</option>")
            
        }

        //filter scancars
        $('#scancars').on('change',function() {

           scancarselected = this.value;

            for (i=0; i<markers.length; i++) {

                marker = gmarkers[i];
                if(marker.category == scancarselected  || scancarselected.length === 0  ) {
                    marker.setVisible(true);}

                else{ marker.setVisible(false);
                }
            }
        })
        
        //show route     
        $("#buttonroute").click(function(){ 

            for (i=0; i<markers.length; i++)
            {
                
                marker = gmarkers[i];
                
                if(marker.category == scancarselected)
                {
                    directionmarkers.push(marker)
                }
        

            };
            x = directionmarkers.length-1;
            
            var start = directionmarkers[0].position;                                              
            var end = directionmarkers[x].position;
                                                
           
            calculateAndDisplayRoute( directionsService,directionsDisplay,start,end)
            directionsmarkers =[];
                
             

            
                          
        })      
        
        $("#buttonroute-hide").click(function(){directionsDisplay.set('directions',null)});


        function calculateAndDisplayRoute(directionsService, directionsDisplay,pointA,pointB,waypts) {
            directionsService.route({
                origin: pointA,
                destination: pointB,
                waypoints : waypts,
                travelMode: google.maps.TravelMode.DRIVING
            }, function(response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                    directionsDisplay.setMap(map);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }
       

        function makemap()
        
        {
            var mapOptions =    {
                center: new google.maps.LatLng(51.20858,3.227961),
                zoom: 14,
                mapTypeId: google.maps.MapTypeId.HYBRID
            };


            map = new google.maps.Map(document.getElementById("map"), mapOptions);
            for (i = 0; i < markers.length; i++) {
                addMarker(markers[i]);

         
            }
           
                        
        }
       
        function addMarker(marker) {

            var category = marker.HTQU_PatrollerMOBI_ID;
            var pos = new google.maps.LatLng(marker.HTQU_Latitude,marker.HTQU_Longitude);
                                     
            
            var datestring = moment(marker.HTQU_CreatedOn).format("MMMM Do YYYY, h:mm:ss a");
            var title = datestring;
            var content = datestring;
           
            var iconcolor = colors[patrollers.indexOf(marker.HTQU_PatrollerMOBI_ID)]
           

            marker = new google.maps.Marker({
                
                title : title,
                position : pos,
                category : category,
               
                map: map,
                animation : google.maps.Animation.DROP,
                icon : 'http://www.google.com/intl/en_us/mapfiles/ms/micons/' + iconcolor + '-dot.png',
               
                
            });

            gmarkers.push(marker);

            //Marker click listener
            google.maps.event.addListener(marker, 'click', function () {
               
                infowindow.setOptions({
                    content : this.title,
                                })
                                                         
                    infowindow.open(map, marker);
                   
                    document.getElementById("infotext").innerHTML="Date and time : <br>"+ title
                 })

        };
               

        makemap();

                   
          
        

      
    </script>
</body>
</html>

    
